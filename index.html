<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RomRaider Log Viewer</title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <script async src="https://arc.io/widget.min.js#J1xRmnAG"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src=".\inc\papaparse.min.js"></script>
  <script src=".\src\data.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
  body {
    margin: 0;
    padding: 0;
	
	}
  .chart-container {
   position: relative;
   margin: auto;
   height: 90vh;
   width: 85vw;
  }
  .baseGraph {
   height: 60vh;
  }
  
  .AFRGraph {
   height: 30vh;
  }
  </style>
</head>
<body>
  <div class="container" style="padding:10px 10px;">
    <h1>RomRaider Log Viewer</h1>
	<div id="header"></div>
	<div class="well">
		<div class="row">
		<form class="form-inline">
			<div class="form-group">RomRaider log file:</label>
			  <input type="file" id="files"  class="form-control" accept=".csv" required />
			</div>
			<div class="form-group">
			 <button type="submit" id="submit-file" class="btn btn-primary">Upload Log</button>
			 </div>
		</form>
		</div>
	</div>
	</div>

  <div class="chart-container">
   <div class="baseGraph">
    <canvas id="baseGraph"></canvas>
   </div>
   <div class="AFRGraph">
	<canvas id="AFRGraph"></canvas>
   </div>
  </div>
<script type="text/javascript">
	var AFConvertVal = 1;
	var sensorcnt = 0;

	var options = {
     maintainAspectRatio: false,
	 spanGaps: true,
	 showLine: true,
	 animation: false,
     scales: {
            'left-y-axis': {
                type: 'linear',
                position: 'left'
            },
            'right-y-axis': {
                type: 'linear',
                position: 'right'
            }
	 },
	 datasets: {
		line: {
			 pointRadius: 2
		}
	 }
	 };
	 
	var optionsAFR = {
     maintainAspectRatio: false,
	 spanGaps: true,
	 showLine: true,
	 animation: false,
     scales: {
            'left-y-axis': {
                type: 'linear',
                position: 'left'
            }
	 },
	 datasets: {
		line: {
			 pointRadius: 2
		}
	 }
	 };
	
	function MapToHeader(item, index){
	  itemLower = item.toLowerCase();
	  
	  /*
		Here we look for specific sensors
	  */
	  if (itemLower.includes("engine speed (rpm)")){
		 rpm.HeaderIndex=index;
	  } else if (itemLower.includes("a/f sensor #1")){
		 afr1.HeaderIndex = index;
		 afr1.SensorName = item;
	  } else if (itemLower.includes("a/f sensor #2")){
		 afr2.HeaderIndex = index;
		 afr2.SensorName = item;
	  } else if (itemLower.includes("final fueling base")){
		 afrTarget.HeaderIndex = index;
	  } else if (index > 0){
		//Just say "fuck it" and hope counting works well.
		sensorcnt++;
		var sensname = "'" + item + "'";
		eval("GenericSensors._" + sensorcnt + ".SensorName = " + sensname); //I did the evil thing
		}
	  };
	  
	function LogSensors(item, index){
		if (index == afr1.HeaderIndex) {
            afr1.Values.push(item);
        } else if (index == afr2.HeaderIndex) {
            afr2.Values.push(item);
        } else if (index == afrTarget.HeaderIndex) {
            afrTarget.Values.push(item * AFConvertVal);
        } else if (index == rpm.HeaderIndex) {
            rpm.Values.push(item);
        } else if (index > 0){
		  sensorcnt++;
		  var sensname = "'" + item + "'";
		  eval("GenericSensors._" + sensorcnt + ".Values.push(" + sensname + ")");//More evil thing. This one may actually be bad
		}
	};

  $(document).ready(function(){
	
    $('#submit-file').on("click",function(e){
		e.preventDefault();
		$('#files').parse({
			config: {
				delimiter: "auto",
				complete: ReadData,
			},
			before: function(file, inputElem)
			{
				//console.log("Parsing file...", file);
			},
			error: function(err, file)
			{
				//console.log("ERROR:", err, file);
			},
			complete: function()
			{
				//console.log("Done with all files");
			}
		});
    });
	
	function ReadData(results){
   
		var data = results.data;
    	for(i=0;i<data.length;i++){
			var row = data[i];
			var header = data[0].join(",").split(",")
			var cells = row.join(",").split(",");
			
			//Time msec - should always be the first cell in a RomRaider log file.
			labels.push(cells[0]);
			
			
			//First row will be the "header" and include the sensor names. Let's read & match these now.
			if (i === 0){
			cells.forEach(MapToHeader);
			} else {
			if (sensorcnt >= cells.length -4) sensorcnt = 0; //More hopeful counting
			cells.forEach(LogSensors);
			}

		}
		DrawChart();
	}
	
function DrawChart(){
const data1 = {
  labels: labels,
  datasets: [{
    label: 'RPM',
    data: rpm.Values,
    fill: false,
    borderColor: 'rgb(255, 0, 0)',
    tension: 0.1,
	yAxisID: 'right-y-axis'

  },
  {
    label: GenericSensors._1.SensorName,
    data: GenericSensors._1.Values,
    fill: false,
    borderColor: 'rgb(255, 94, 0)',
    tension: 0.1,
	yAxisID: 'left-y-axis',
	hidden: true
  },
  {
    label: GenericSensors._2.SensorName,
    data: GenericSensors._2.Values,
    fill: false,
    borderColor: 'rgb(0, 77, 255)',
    tension: 0.1,
	yAxisID: 'left-y-axis',
	hidden: true
  },
  {
    label: GenericSensors._3.SensorName,
    data: GenericSensors._3.Values,
    fill: false,
    borderColor: 'rgb(0, 77, 255)',
    tension: 0.1,
	yAxisID: 'left-y-axis',
	hidden: true
  },
  {
    label: GenericSensors._4.SensorName,
    data: GenericSensors._4.Values,
    fill: false,
    borderColor: 'rgb(0, 140, 255)',
    tension: 0.1,
	yAxisID: 'left-y-axis',
	hidden: true
  },
  {
    label: GenericSensors._5.SensorName,
    data: GenericSensors._5.Values,
    fill: false,
    borderColor: 'rgb(0, 210, 255)',
    tension: 0.1,
	yAxisID: 'left-y-axis',
	hidden: true
  },
  {
    label: GenericSensors._6.SensorName,
    data: GenericSensors._6.Values,
    fill: false,
    borderColor: 'rgb(70, 210, 200)',
    tension: 0.1,
	yAxisID: 'left-y-axis',
	hidden: true
  },
  {
    label: GenericSensors._7.SensorName,
    data: GenericSensors._7.Values,
    fill: false,
    borderColor: 'rgb(140, 255, 170)',
    tension: 0.1,
	yAxisID: 'left-y-axis',
	hidden: true
  },
  {
    label: GenericSensors._8.SensorName,
    data: GenericSensors._8.Values,
    fill: false,
    borderColor: 'rgb(200, 77, 255)',
    tension: 0.1,
	yAxisID: 'left-y-axis',
	hidden: true
  },
  {
    label: GenericSensors._9.SensorName,
    data: GenericSensors._9.Values,
    fill: false,
    borderColor: 'rgb(255, 77, 70)',
    tension: 0.1,
	yAxisID: 'left-y-axis',
	hidden: true
  },
  {
    label: GenericSensors._11.SensorName,
    data: GenericSensors._11.Values,
    fill: false,
    borderColor: 'rgb(255, 77, 70)',
    tension: 0.1,
	yAxisID: 'left-y-axis',
	hidden: true
  },
  {
    label: GenericSensors._12.SensorName,
    data: GenericSensors._12.Values,
    fill: false,
    borderColor: 'rgb(255, 77, 70)',
    tension: 0.1,
	yAxisID: 'left-y-axis',
	hidden: true
  },
  {
    label: GenericSensors._13.SensorName,
    data: GenericSensors._13.Values,
    fill: false,
    borderColor: 'rgb(255, 77, 70)',
    tension: 0.1,
	yAxisID: 'left-y-axis',
	hidden: true
  },
  {
    label: GenericSensors._14.SensorName,
    data: GenericSensors._14.Values,
    fill: false,
    borderColor: 'rgb(255, 77, 70)',
    tension: 0.1,
	yAxisID: 'left-y-axis',
	hidden: true
  },
  {
    label: GenericSensors._15.SensorName,
    data: GenericSensors._15.Values,
    fill: false,
    borderColor: 'rgb(255, 77, 70)',
    tension: 0.1,
	yAxisID: 'left-y-axis',
	hidden: true
  }
  ]
};
const dataAFR = {
  labels: labels,
  datasets: [{
    label: "Target AFR",
    data: afrTarget.Values,
    fill: false,
    borderColor: 'rgb(255, 51, 51)',
    tension: 0.1,
	yAxisID: 'left-y-axis'
  },
  {
    label: afr1.SensorName,
    data: afr1.Values,
    fill: false,
    borderColor: 'rgb(75, 192, 192)',
    tension: 0.1,
	yAxisID: 'left-y-axis'
  },
  {
    label: afr2.SensorName,
    data: afr2.Values,
    fill: false,
    borderColor: 'rgb(140, 192, 192)',
    tension: 0.1,
	yAxisID: 'left-y-axis'
  }]
};
		
        var ctx = document.getElementById('baseGraph');
        var TheBaseGraph = new Chart(ctx, {
         options: options,
		 type: 'line',
         data: data1
        });
		
		ctx = document.getElementById('AFRGraph');
		var TheAFRGraph = new Chart(ctx, {
         options: optionsAFR,
		 type: 'line',
         data: dataAFR
        });
	}
  });

</script>
</body>
</html>
